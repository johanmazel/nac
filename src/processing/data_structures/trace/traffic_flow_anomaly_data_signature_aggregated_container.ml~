
open Printf

open Traffic_flow_aggr_data_instantiations

let debug_enabled = ref false

let set_debug bool = debug_enabled := bool

let debug fmt =
  Printf.kprintf
    (
      if !debug_enabled then
  (fun s -> Format.printf "[Traffic_flow_anomaly_data_signature_aggregated_container]: %s@." s)
      else
  ignore
    )
    fmt

type t =
  {
    hashtable : (Traffic_flow_key_type.aggr_mode_t, Traffic_flow_anomaly_data_signature_aggr_data.Aggr_key_data_container.t) Hashtbl.t;
  }

let new_t
    hashtable
  =
  {
    hashtable = hashtable;
  }

let length t = Hashtbl.length t.hashtable

let map_to_hashtbl
    f
    t
  =
  Batteries.Hashtbl.map
    f
    t.hashtable

let fold
    f
    t
  =
  Hashtbl.fold
    f
    t.hashtable

let of_traffic_flow_classification_data_aggregated_container
    parallelization_mode
    anomaly_taxonomy
    traffic_flow_classification_data_aggregated_container
  =
  debug "of_traffic_flow_classification_data_aggregated_container: call";

  let anomaly_taxonomy_manager =
    Anomaly_taxonomy_manager.of_anomaly_taxonomy
      anomaly_taxonomy
  in

  let hashtable = 
    Batteries.Hashtbl.map
      (fun
        key_aggr_mode 
        traffic_flow_detailed_metrics_key_aggr_data_container
        ->
          (
            let key_aggr_mode_from_data =
              traffic_flow_detailed_metrics_key_aggr_data_container.Traffic_flow_classification_data_aggr_data.Aggr_key_data_container.key_aggr_mode 
            in

            assert(Traffic_flow_key_type.compare_aggr key_aggr_mode key_aggr_mode_from_data = 0);

            let anomaly_signature_matching_mode =
              match key_aggr_mode with
              | Traffic_flow_key_type.All_mode -> failwith "Traffic_flow_anomaly_data_signature_aggregated_container: of_traffic_flow_classification_data_aggregated_container: cannot calssify anomalies when traffic is completly aggregated (All)"
              | Traffic_flow_key_type.Src_addr_mode -> Anomaly_signature_matching_mode.Src
              | Traffic_flow_key_type.Dst_addr_mode -> Anomaly_signature_matching_mode.Dst
            in

            let tuple_list =
              Batteries.List.of_enum
                (Batteries.Hashtbl.enum
                   (Traffic_flow_classification_data_aggr_data.Aggr_key_data_container.map_to_hashtbl
                      (fun classification_data -> classification_data)
                      traffic_flow_detailed_metrics_key_aggr_data_container
                   )
                )
            in

            let tuple_list_mapped =
              Map_data.map_list
                parallelization_mode
                (fun (aggr_key, classification_data) ->
                   (aggr_key
                    ,
                    (
                      classification_data.Classification_data.detailed_metrics
                      ,
                      classification_data.Classification_data.network_traffic_attributes
                      ,
                      classification_data.Classification_data.network_traffic_values
                      ,
                      (Anomaly_taxonomy_manager.classify_option
                         anomaly_taxonomy_manager
                         (Network_traffic_attributes.to_string
                            classification_data.Classification_data.network_traffic_attributes)
                         anomaly_signature_matching_mode
                         classification_data.Classification_data.network_traffic_attributes
                         classification_data.Classification_data.network_traffic_values
                      )
                    )
                   )
                )
                tuple_list
            in

            (* let hashtable_temp =  *)
            (*   Traffic_flow_classification_data_aggr_data_functor.Aggr_key_data_container.map_to_hashtbl *)
            (*     (fun classification_data -> *)
            (*   let anomaly_signature_option = *)
            (*     Anomaly_taxonomy.classify_option *)
            (*       anomaly_taxonomy *)
            (*       (Network_attributes.to_string To_string_mode.Normal classification_data.Classification_data.network_attributes) *)
            (*       anomaly_signature_matching_mode *)
            (*       classification_data.Classification_data.network_attributes *)
            (*   in *)

            (*   ( *)
            (*     classification_data.Classification_data.detailed_metrics *)
            (*       , *)
            (*     classification_data.Classification_data.network_attributes *)
            (*       , *)
            (*     anomaly_signature_option *)
            (*   ) *)
            (*     ) *)
            (*     traffic_flow_detailed_metrics_key_aggr_data_container *)
            (* in *)

            let hashtable_temp =
              Batteries.Hashtbl.of_enum
                (Batteries.List.enum
                   tuple_list_mapped
                )
            in

            let hashtable_temp_filtered =
              Batteries.Hashtbl.filter
                (fun (_, _, _, anomaly_signature_option) ->
                   match anomaly_signature_option with
                   | None -> false
                   | Some _ -> true
                )
                hashtable_temp
            in
            let hashtable_temp_filtered_mapped =
              Batteries.Hashtbl.map
                (fun key_aggr (detailed_metrics, network_traffic_attributes, network_traffic_values, anomaly_signature_option) ->
                   match anomaly_signature_option with
                   | None -> assert(false)
                   | Some anomaly_signature -> (detailed_metrics, network_traffic_attributes, network_traffic_values, anomaly_signature)
                )
                hashtable_temp_filtered
            in

            let hashtable =
              Batteries.Hashtbl.map
                (fun key_aggr (detailed_metrics, network_traffic_attributes, network_traffic_values, anomaly_signature) ->

                   let anomaly_raw_data =
                     Anomaly_raw_data.of_detailed_metrics
                       detailed_metrics
                   in

                   Anomaly_data_signature.new_t
                     detailed_metrics
                     network_traffic_attributes
                     network_traffic_values
                     anomaly_raw_data
                     anomaly_signature
                )
                hashtable_temp_filtered_mapped
            in

            Traffic_flow_anomaly_data_signature_aggr_data.Aggr_key_data_container.of_aggr_key_data_hashtable
              key_aggr_mode
              hashtable
          )
      )
      traffic_flow_classification_data_aggregated_container.Traffic_flow_classification_data_aggregated_container.hashtable
  in

  debug "of_traffic_flow_classification_data_aggregated_container: end";

  new_t
    hashtable

