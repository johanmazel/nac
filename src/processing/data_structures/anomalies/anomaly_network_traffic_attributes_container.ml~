
open Printf

open Maps

open Ipv4
open Tcp
open Udp
open Icmp

(* open Admd_functor_declaration *)
(* open Mawilab_admd_functor_declaration *)

let debug_enabled = ref false

let set_debug bool = debug_enabled := bool

let debug fmt =
  Printf.kprintf
    (
      if !debug_enabled then
	(fun s -> Format.printf "[Anomaly_detailed_metrics_container]: %s@." s)
      else
	ignore
    )
    fmt

type t =
  {
    map : Network_traffic_attributes.t Int_map.t;
  }

let new_t
    map
    =
  {
    map;
  }

let to_string to_string_mode t =
  match to_string_mode with
  | To_string_mode.Command ->
    Maps.Int_map.to_string
      ~sep: "\n\n"
      (* ~sep_key_value: ": " *)
      (* ~display_key: true *)
      (* (fun detailed_metrics -> Network_traffic_attributes.to_string to_string_mode detailed_metrics) *)
      (fun indice detailed_metrics -> sprintf "%d: %s" indice (Network_traffic_attributes.to_string to_string_mode detailed_metrics))
      t.map
  | To_string_mode.Simple ->
    Maps.Int_map.to_string
      ~sep: "\n\n"
      (* ~sep_key_value: ": " *)
      (* ~display_key: true *)
      (* (fun detailed_metrics -> Network_traffic_attributes.to_string to_string_mode detailed_metrics) *)
      (fun indice detailed_metrics -> sprintf "%d: %s" indice (Network_traffic_attributes.to_string to_string_mode detailed_metrics))
      t.map
  | To_string_mode.Normal ->
    Maps.Int_map.to_string
      ~sep: "\n\n"
      (* ~sep_key_value: ": " *)
      (* ~display_key: true *)
      (* (fun detailed_metrics -> Network_traffic_attributes.to_string to_string_mode detailed_metrics) *)
      (fun indice detailed_metrics -> sprintf "%d: %s" indice (Network_traffic_attributes.to_string to_string_mode detailed_metrics))
      t.map

let of_trace_statistics_anomaly_detailed_metrics_container
    trace_statistics
    anomaly_detailed_metrics_container
    =
  let detailed_metrics_int_map =
    Hashtbl.fold
      (fun int tuple int_map ->
        Int_map.add
          int 
          tuple
          int_map
      )
      anomaly_detailed_metrics_container.Anomaly_detailed_metrics_container.detailed_metrics_hashtable
      Int_map.empty
  in

  let int_map =
    Int_map.map
      (fun detailed_metrics -> Network_traffic_attributes.of_trace_statistics_detailed_metrics trace_statistics detailed_metrics)
      detailed_metrics_int_map
  in
  
  new_t
    int_map

let to_int_map t = t.map

let find indice t = Int_map.find indice t.map
