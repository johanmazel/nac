
let debug_enabled = ref false

let set_debug bool = debug_enabled := bool

let debug fmt =
  Printf.kprintf
    (
      if !debug_enabled then
  (fun s -> Format.printf "[Network_attribute_signature_comparator]: %s@." s)
      else
  ignore
    )
    fmt

let compare
    network_traffic_attributes
    network_traffic_values
    anomaly_signature
  =
  (
    let result =
      Anomaly_signature.fold_wo_acc
        (fun rule ->
           match rule with
           | Rule.Feature feature_rule ->
             let feature = feature_rule.Feature_rule.feature in

             let feature_indice = feature.Feature.indice in
             let attribute_value =
               Network_traffic_attributes.find_indice
                 network_traffic_attributes
                 feature_indice
             in

             let result =
               Feature_rule.test_value
                 feature_rule
                 attribute_value
             in

             result
           | Rule.Feature_arithmetic_expression feature_arithmetic_expression_rule ->
             (
               let value =
                 Feature_arithmetic_expression_rule.fold
                   (fun feature ->
                      let attribute_value =
                        Network_traffic_attributes.find_indice
                          network_traffic_attributes
                          feature.Feature.indice
                      in

                      attribute_value
                   )
                   (fun ao f1 f2 -> Arithmetic_operator.apply f1 f2 ao)
                   feature_arithmetic_expression_rule
               in


               let result =
                 Feature_arithmetic_expression_rule.test_value
                   feature_arithmetic_expression_rule
                   value
               in

               result
             )
           | Rule.Metric metric_rule ->
             let metric = metric_rule.Metric_rule.metric in

             let metric_indice = metric.Metric.indice in
             let metric_value =
               Network_traffic_values.find_indice
                 network_traffic_values
                 metric_indice
             in

             let result =
               Metric_rule.test_value
                 metric_rule
                 metric_value
             in
             result
        )
        (fun boolean_operator bool_list ->
           match List.length bool_list with
           | 0 ->
             false
           | 1 ->
             List.hd bool_list
           | _ ->
             List.fold_left
               (fun acc bool ->
                  Boolean_operator.apply boolean_operator acc bool
               )
               (List.hd bool_list)
               (List.tl bool_list)

        )
        anomaly_signature
    in

    result
  )
